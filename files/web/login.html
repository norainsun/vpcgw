<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=640, maximum-scale=1">
    <title>通联资管云 统一认证平台</title>
    <link rel="icon" href="img/favicon.ico">
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/login.css">

    <script type="text/javascript" src="https://achilles.wmcloud.com/js/lib/jquery-1.8.1.min.js"></script>
</head>
<body onload="init()">

<div class="header">
    <div class="container">
        <!-- logo -->
<div class="header-logo"><i class="i_header_logo" style=" float: left;"></i><span class="logo-text" style="
    font-size: 25px;    color: #c69a69;    font-weight: bold;    /* margin-left: 60px; */ float: left; ">通联资管云</span></div>
    </div>
</div>

<div id="page-wrapper">
    <div class="position">
        <div class="login-panel">
            <div class="hook"></div>
            <div id="form" class="form" style="display: block;">
                <a href="http://vpc.datayes.com/#/main" target="_blank">
                    <div class="logo"></div>
                </a>

                <form action="" method="post" id="loginForm" onsubmit="return loginSubmit();">
                    <div class="loginIpt" style="display:none">
                        <div class="input ipt-name">
                            <span class="icon icon-user"></span>
                            <input type="text" name="username" id="account" placeholder="用户名" maxlength="40" autofocus />
                            <span class="icon icon-close"></span>
                        </div>
                        <div class="input ipt-pw">
                            <span class="icon icon-password"></span>
                            <input type="password" name="password" id="password" placeholder="请输入密码" maxlength="20" />
                            <span class="icon icon-close"></span>
                        </div>
                        <input type="hidden" name="RelayState" id="relaystate"/>
                    </div>
                    <input type="hidden" name="identityType" value="PASSPORT"/>
                    <div class="error-message" style="display:none">
                        <div id="errorMsg" style="display: none">
                            请检查用户名和密码或联系管理员。
                        </div>
                    </div>
                    <div class="valid-message" >
                        <div >
                             系统正在验证身份，请稍等。
                        </div>
                    </div>
                    <div class="success-message" style="display:none">
                        <div>
                            登录成功，正在为您跳转，请稍等... <br/>
                            您可以选择跳转到<a  style="float: initial" href="http://vpc.datayes.com">通联资管云 主页</a>。
                        </div>
                    </div>
                    <div class="action">
                        <button type="button" onclick="return loginSubmit();" id="btnLogin" style="display:none">登&nbsp;录</button>
                        <input type="submit" value="登录"
                               style="display:block;overflow:hidden;visibility: hidden;width:0px;height:0px;position:absolute"/>
                    </div>
                </form>
<script type="text/javascript">
    function init(){
        var args = getArgs();

        var relayState = args["RelayState"] || args["ReplyState"];
        if (relayState != null)
            document.getElementById('relaystate').value = relayState;

        var token = args["token"];
        if (token != undefined)
        {
            try_login({'token':token, 'relaystate':relayState})
        }
//        l = location.hostname.split(".")
//        l.shift()
//        cookie_domain = l.join(".")
//        if ((token != null) && (token != "")) {
//            $.cookie('cloud-sso-token', token, { domain: cookie_domain, path: '/' });
//            if((relayState != null) && (relayState != "")){
//            	window.location.href = relayState
//		return 
//		}
//
//        }
        var fail = args["fail"];
        if (fail == "true") {
            document.getElementById("loginForm").className = 'error';
            document.getElementById("errorMsg").style.display = 'inline';
        }
        else {
            document.getElementById("loginForm").className = '';
            document.getElementById("errorMsg").style.display = 'none';
        }

        $.ajax({
            url: getTargetGW() + '/usermaster/identity.json',
            type: 'GET',
            timeout: 5000,
            xhrFields: {
                withCredentials: true
            },
            success: function(data) {
                if (!data || data.anonymous) {
                    return failToLogin();
                }
                else {
                    window.location.href = relayState;
                }
            },
            error: failToLogin
        });


    }

    function failToLogin() {
        $(".loginIpt").css("display", "block");
        $(".error-message").css("display", "block");
        $("#btnLogin").css("display", "block");
        $(".success-message").css("display", "none");
        $(".valid-message").css("display", "none");
    }

    function getTargetGW() {
        loc = location.hostname.split(".");
        loc[0] = "gw";
        target = loc.join(".")
        if (location.port != "" )
        {
            target_url = location.portocol + "//" +target + ":" + location.port
        }
        else
        {
            target_url = location.protocol + "//" + target
        }
        return target_url
    }

    function getArgs() {
        var args = {};
        var match = null;
        var search = location.href.substring(location.href.indexOf("?") + 1);
        var reg = /([^&]+?)=([^&]+)/g;
        while ((match = reg.exec(search)) !== null) {
            args[match[1]] = decodeURIComponent(match[2]);
        }
        return args;
    }

    function loginSubmit() {
        var f = document.getElementById('loginForm');
        try_login({'username':f.username.value, 'password':f.password.value, 'relaystate':f.relaystate.value})
        return false;
    }

    function try_login(input) {
	if (( input['token'] == undefined ) || (input['token'] == "" ))
	{
            data = {
                "username": input['username'],
                "password": input['password'],
                "identityType": "VPC"
            };
	}
        else
        {
            data = {
                "username": input['token'],
                "password": input['token'],
                "identityType": "VPC_TOKEN"
            };
        }


        var requestText = "";
        for (var key in data) {
            requestText += "&" + key + "=" + encodeURIComponent(data[key]);
        };

        next = input['relaystate'];
        var xmlHTTPRequest = new XMLHttpRequest();
        xmlHTTPRequest.readyState = 0;
        xmlHTTPRequest.onreadystatechange = function() {

            if (xmlHTTPRequest.readyState <= 1) {
                try {
                    xmlHTTPRequest.withCredentials = "true";
                } catch (e) {
                 //   alert(e);
                }
            }
            if (xmlHTTPRequest.readyState == 4 && xmlHTTPRequest.status == 200) {
                var responseJson = JSON.parse(xmlHTTPRequest.responseText);
                if (responseJson['content'] != null && responseJson['content']['result'] == "SUCCESS") {
                    $(".loginIpt").css("display", "none");
                    $(".error-message").css("display", "none");
                    $("#btnLogin").css("display", "none");
                    $(".valid-message").css("display", "none");
                    $(".success-message").css("display", "block");
                    if((next != undefined) && (next != "")){
                        window.location.href = next;
                    }
                }
                else{
                    document.getElementById("errorMsg").style.display = "block";
                }
            }
        }

        xmlHTTPRequest.open("POST", getTargetGW() + "/usermaster/authenticate.json", true);
        xmlHTTPRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        xmlHTTPRequest.send(requestText);
    }

</script>
                <span id="to-code" class="icon icon-code to-code" style="display: none;"></span>
            </div>
        </div>

    </div>
</div>


<div class="footer-bottom">
    <p>
        <span>© 2015 <a href="http://vpc.datayes.com" target="_blank" class="agreement-link" target="_blank">DataYes</a></span>
        <a class="icp" href="http://www.miibeian.gov.cn/" target="_blank">沪ICP备13045831号</a>
        <span>咨询热线：4000 820 386</span>

        <a href="http://www.datayes.com/#/protocol" target="_blank" class="agreement-link">用户协议</a>
    </p>
</div>

</body>
</html>
